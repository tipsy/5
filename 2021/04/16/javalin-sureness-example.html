<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-54137818-11"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-54137818-11', {'anonymize_ip': true});
</script>
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Oxygen+Mono|Roboto+Slab:500,700&display=swap" rel="stylesheet">
    <meta property="og:title" content="Using Sureness to protect the security of Javalin REST API - Javalin - A lightweight Java and Kotlin web framework. Create REST APIs in Java or Kotlin easily.">
    <meta property="og:site_name" content="Javalin">
    <meta property="og:url" content="https://javalin.io">
    <meta property="og:description" content="What is Sureness">
    <meta property="og:image" content="https://javalin.io/img/javalin.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="liMtSlffOZROWLqoiOZdSx-luH9_Siq5-Ot6xqHZwq8">
    <title>
        Using Sureness to protect the security of Javalin REST API - Javalin - A lightweight Java and Kotlin web framework
    </title>
    <meta name="description" content="What is Sureness">
    <link rel="canonical" href="https://zugazagoitia.github.io/2021/04/16/javalin-sureness-example.html">
    <link rel="shortcut icon" type="image/png" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/main.css">
    <style>/* Styles that affect the length of the document */
p code,
li code {
    font-size: 90%;
    letter-spacing: -0.5px;
    border: 1px solid #ccd;
    background: #f5f5f7;
    padding: 1px 3px;
}

.multitab-code pre {
    margin-top: 0;
    border-radius: 0 0 5px 5px;
}

.multitab-code div[data-tab] {
    display: none;
}

:target {
    scroll-margin-top: 108px;
}

.anchorjs-link {
    transition: all .25s linear;
  }
  
*:hover > .anchorjs-link {
    margin-left: -1.125em !important;
 }</style>
</head>
<body>
    <a id="fork-me" href="https://github.com/javalin/javalin" target="_blank">
    <img style="position:fixed;top:0;right:0;border:0;z-index:99999" src="data:image/png;base64,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" alt="Fork me on GitHub">
</a>
    <header class="top-nav-header">
        <nav class="width-limit">
            <a id="logo" href="/" aria-label="Javalin">
                <img src="/img/logo.svg" alt="Javalin">
            </a>
            <ul>
                <li><a href="/documentation">Docs</a></li>
                <li><a href="/tutorials">Tutorials</a></li>
                <li><a href="/plugins">Plugins</a></li>
                <li><a href="/community">Community</a></li>
            </ul>
        </nav>
    </header>
    <main class="width-limit">
        <article class="tutorial" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="tutorial-header">
        <h1 class="no-margin-top" itemprop="name headline">Using Sureness to protect the security of Javalin REST API</h1>
        <p class="notification">
            <time datetime="2021-04-16T00:00:00+00:00" itemprop="datePublished">Apr 16, 2021</time>
             
                â€¢ Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href="https://github.com/tomsun28" target="_blank">Tom</a></span></span>
            
            <span id="timeToRead">Reading time: <b>0-0 min</b></span>
            
        </p>
        
    </div>
    <div class="post-content" itemprop="articleBody">
        <h2 id="what-is-sureness">What is Sureness</h2>

<blockquote>
  <p><a href="https://github.com/usthe/sureness">Sureness</a> is a simple and efficient open-source security framework that focus on the protection of REST API.
Provide authentication and authorization, based on RBAC.
No specific framework dependency (supports Javalin, Spring Boot, Quarkus, Ktor, and more).
Supports dynamic modification of permissions.
Supports WebSocket and mainstream HTTP containers (Servlet and JAX-RS).
Supports JWT, Basic Auth, Digest Auth, and can be extended to support custom authentication methods.
High performance due to dictionary matching tree.
Good extension interface, demos and documentation.
Sureness has a sensible default configuration, is easy to customize, and is not couple to any one framework, which enables developers to quickly and safely protect their projects in multiple scenarios.</p>
</blockquote>

<h2 id="what-you-will-learn">What You Will Learn</h2>

<ul>
  <li>Creating a simple REST API using Javalin</li>
  <li>Learn how to integrate Sureness into a Javalin application</li>
  <li>Learn how to issue a JWT</li>
  <li>Test API authentication - use JWT Auth, Basic Auth, Digest Auth to test the security of the REST API</li>
  <li>Test API authorization - use different users to verify that they can access the REST API</li>
</ul>

<p>The tutorial assumes that you know what  JWT, Basic Auth, Digest Auth, RBAC are. If you
do not, then you can check <a href="https://jwt.io/introduction/">JWT</a>, <a href="https://docs.oracle.com/cd/E50612_01/doc.11122/user_guide/content/authn_http_basic.html">Basic Auth</a> , <a href="https://docs.oracle.com/cd/E50612_01/doc.11122/user_guide/content/authn_http_digest.html">Digest Auth</a>, <a href="https://en.wikipedia.org/wiki/Role-based_access_control">RBAC</a> for an introduction.</p>

<h2 id="setting-up-dependencies">Setting Up Dependencies</h2>

<p>First, you will need to create a maven project and add Javalin, Sureness dependencies coordinate</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.javalin<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>javalin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.13.13<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.usthe.sureness<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>sureness-core<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>slf4j-simple<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.7.30<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h2 id="setting-up-javalin-and-create-rest-api">Setting Up Javalin and Create REST API</h2>

<p>We need to create a simple Javalin app and provide a REST API for testing:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Javalin</span> <span class="n">app</span> <span class="o">=</span> <span class="nc">Javalin</span><span class="o">.</span><span class="na">create</span><span class="o">().</span><span class="na">routes</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">path</span><span class="o">(</span><span class="s">"api"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">path</span><span class="o">(</span><span class="s">"v3"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">get</span><span class="o">(</span><span class="s">"host"</span><span class="o">,</span> <span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"get /api/v3/host success"</span><span class="o">));</span>
            <span class="n">put</span><span class="o">(</span><span class="s">"book"</span><span class="o">,</span> <span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"put /api/v3/book success"</span><span class="o">));</span>
        <span class="o">});</span>
        <span class="n">path</span><span class="o">(</span><span class="s">"v2"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">path</span><span class="o">(</span><span class="s">"host"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">get</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"get /api/v2/host success"</span><span class="o">));</span>
                <span class="n">post</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"post /api/v2/host success"</span><span class="o">));</span>
                <span class="n">put</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"put /api/v2/host success"</span><span class="o">));</span>
                <span class="n">delete</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"delete /api/v2/host success"</span><span class="o">));</span>
            <span class="o">});</span>
        <span class="o">});</span>
        <span class="n">path</span><span class="o">(</span><span class="s">"v1"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">path</span><span class="o">(</span><span class="s">"source1"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">get</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"get /api/v1/source1 success"</span><span class="o">));</span>
                <span class="n">post</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"post /api/v1/source1 success"</span><span class="o">));</span>
                <span class="n">put</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"put /api/v1/source1 success"</span><span class="o">));</span>
                <span class="n">delete</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"delete /api/v1/source1 success"</span><span class="o">));</span>
            <span class="o">});</span>
        <span class="o">});</span>
    <span class="o">});</span>
<span class="o">}).</span><span class="na">start</span><span class="o">(</span><span class="mi">8088</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="setting-up-sureness">Setting Up Sureness</h2>

<h4 id="1-use-the-default-configuration-to-configure-sureness">1. Use the Default Configuration to Configure Sureness</h4>

<p>The default configuration -<code class="language-plaintext highlighter-rouge">DefaultSurenessConfig</code> uses the document datasource <code class="language-plaintext highlighter-rouge">sureness.yml</code> as the auth datasource.
It supports JWT, Basic Auth, Digest Auth authentication.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// init sureness default config</span>
    <span class="k">new</span> <span class="nf">DefaultSurenessConfig</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="2-config-document-datasource---surenessyml">2. Config Document Datasource - <code class="language-plaintext highlighter-rouge">sureness.yml</code></h4>

<p>Sureness authentication requires us to provide our own account data, role permission data. These data may come from document, databases,, annotations, etc. When we use sureness default configuration above, the datasource is document - <code class="language-plaintext highlighter-rouge">sureness.yml</code>.</p>

<p>Create a file named <code class="language-plaintext highlighter-rouge">sureness.yml</code> in the <code class="language-plaintext highlighter-rouge">resource</code> directory. Configure account data, role permission data in the <code class="language-plaintext highlighter-rouge">sureness.yml</code>.  eg:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## -- sureness.yml document dataSource-- ##</span>

<span class="c1"># load api resource which need be protected, config role who can access these resource.</span>
<span class="c1"># resources that are not configured are also authenticated and protected by default, but not authorized</span>
<span class="c1"># eg: /api/v2/host===post===[role2,role3] means /api/v2/host===post can be access by role2,role3</span>
<span class="c1"># eg: /api/v1/source2===get===[] means /api/v1/source2===get can not be access by any role</span>
<span class="na">resourceRole</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">/api/v1/source1===get===[role2]</span>
  <span class="pi">-</span> <span class="s">/api/v1/source1===post===[role1]</span>
  <span class="pi">-</span> <span class="s">/api/v1/source1===delete===[role3]</span>
  <span class="pi">-</span> <span class="s">/api/v1/source1===put===[role1,role2]</span>
  <span class="pi">-</span> <span class="s">/api/v1/source2===get===[]</span>
  <span class="pi">-</span> <span class="s">/api/v2/host===post===[role2,role3]</span>
  <span class="pi">-</span> <span class="s">/api/v2/host===get===[role2,role3]</span>
  <span class="pi">-</span> <span class="s">/api/v2/host===delete===[role2,role3]</span>
  <span class="pi">-</span> <span class="s">/api/v2/host===put===[role2,role3]</span>
  <span class="pi">-</span> <span class="s">/api/v3/*===*===[role1,role2,role3]</span>

<span class="c1"># load api resource which do not need be protected, means them need be excluded.</span>
<span class="c1"># these api resource can be access by everyone</span>
<span class="na">excludedResource</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">/api/v3/host===get</span>
  <span class="pi">-</span> <span class="s">/**/*.html===get</span>
  <span class="pi">-</span> <span class="s">/**/*.js===get</span>
  <span class="pi">-</span> <span class="s">/**/*.css===get</span>
  <span class="pi">-</span> <span class="s">/**/*.ico===get</span>

<span class="c1"># account info</span>
<span class="c1"># there are three account: admin, root, tom</span>
<span class="c1"># eg: admin has [role1,role2] ROLE, unencrypted password is admin, encrypted password is 0192023A7BBD73250516F069DF18B500</span>
<span class="c1"># eg: root has role1, unencrypted password is 23456</span>
<span class="c1"># eg: tom has role3, unencrypted password is 32113</span>
<span class="na">account</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">appId</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="c1"># if add salt, the password is encrypted password - the result: MD5(password+salt)</span>
    <span class="c1"># digest auth not support encrypted password</span>
    <span class="c1"># if no salt, the password is unencrypted password</span>
    <span class="na">credential</span><span class="pi">:</span> <span class="s">0192023A7BBD73250516F069DF18B500</span>
    <span class="na">salt</span><span class="pi">:</span> <span class="m">123</span>
    <span class="na">role</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">role1</span><span class="pi">,</span><span class="nv">role2</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">appId</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">credential</span><span class="pi">:</span> <span class="m">23456</span>
    <span class="na">role</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">role1</span><span class="pi">,</span><span class="nv">role2</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">appId</span><span class="pi">:</span> <span class="s">tom</span>
    <span class="na">credential</span><span class="pi">:</span> <span class="m">32113</span>
    <span class="na">role</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">role3</span><span class="pi">]</span>

</code></pre></div></div>

<h4 id="3-add-an-interceptor-intercepting-all-requests">3. Add an Interceptor Intercepting All Requests</h4>

<p>The essence of sureness is to intercept all rest requests for authenticating and authorizing.     The interceptor can be a filter or interceptor, it intercepts all request to check them. In Javalin, we use <code class="language-plaintext highlighter-rouge">app.before()</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// intercept all rest requests for authenticating and authorizing</span>
<span class="n">app</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">SubjectSum</span> <span class="n">subject</span> <span class="o">=</span> <span class="nc">SurenessSecurityManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">checkIn</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">req</span><span class="o">);</span>
    <span class="c1">// when auth error , the exception throw, you should use app.exception() catch it and define return</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subject</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SurenessContextHolder</span><span class="o">.</span><span class="na">bindSubject</span><span class="o">(</span><span class="n">subject</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>

<span class="n">app</span><span class="o">.</span><span class="na">after</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span>  <span class="nc">SurenessContextHolder</span><span class="o">.</span><span class="na">unbindSubject</span><span class="o">());</span>
</code></pre></div></div>

<h4 id="4-last-implement-auth-exception-handling-process">4. Last, Implement Auth Exception Handling Process</h4>

<p>Sureness uses exception handling process:</p>

<ul>
  <li>If auth success, method - <code class="language-plaintext highlighter-rouge">checkIn()</code> will return a <code class="language-plaintext highlighter-rouge">SubjectSum</code> object containing user information.</li>
  <li>If auth failure, method - <code class="language-plaintext highlighter-rouge">checkIn()</code> will throw different types of auth exceptions.</li>
</ul>

<p>We need to continue the subsequent process based on these exceptions.(eg: return the request response)</p>

<p>Here we need to customize the exceptions thrown by <code class="language-plaintext highlighter-rouge">checkIn</code>, passed directly when auth success, catch exception when auth failure and do something:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// when auth error , the exception throw, you should use app.exception() catch it and define return</span>
<span class="n">app</span><span class="o">.</span><span class="na">exception</span><span class="o">(</span><span class="nc">UnknownAccountException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"this request user account not exist"</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">401</span><span class="o">).</span><span class="na">result</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
<span class="o">}).</span><span class="na">exception</span><span class="o">(</span><span class="nc">IncorrectCredentialsException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"this account credential is incorrect"</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">401</span><span class="o">).</span><span class="na">result</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
<span class="o">}).</span><span class="na">exception</span><span class="o">(</span><span class="nc">ExpiredCredentialsException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"this account credential expired"</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">401</span><span class="o">).</span><span class="na">result</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
<span class="o">}).</span><span class="na">exception</span><span class="o">(</span><span class="nc">NeedDigestInfoException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"you should try once again with digest auth information"</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">401</span><span class="o">).</span><span class="na">header</span><span class="o">(</span><span class="s">"WWW-Authenticate"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getAuthenticate</span><span class="o">());</span>
<span class="o">}).</span><span class="na">exception</span><span class="o">(</span><span class="nc">UnauthorizedException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"this account can not access this resource"</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">403</span><span class="o">).</span><span class="na">result</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
<span class="o">}).</span><span class="na">exception</span><span class="o">(</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"other exception happen: "</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">500</span><span class="o">).</span><span class="na">result</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
<span class="o">});</span>
</code></pre></div></div>

<h2 id="provide-an-issue-jwt-api">Provide an Issue JWT API</h2>

<p>Now we provide a REST API to issue JWT. We can use this JWT to test JWT auth.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// issue jwt rest api</span>
<span class="n">app</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/auth/token"</span><span class="o">,</span> <span class="n">ctx</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">SubjectSum</span> <span class="n">subjectSum</span> <span class="o">=</span> <span class="nc">SurenessContextHolder</span><span class="o">.</span><span class="na">getBindSubject</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subjectSum</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="s">"Please auth!"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">subjectSum</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">roles</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;)</span> <span class="n">subjectSum</span><span class="o">.</span><span class="na">getRoles</span><span class="o">();</span>
        <span class="c1">// issue jwt</span>
        <span class="nc">String</span> <span class="n">jwt</span> <span class="o">=</span> <span class="nc">JsonWebTokenUtil</span><span class="o">.</span><span class="na">issueJwt</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">principal</span><span class="o">,</span>
                <span class="s">"token-server"</span><span class="o">,</span> <span class="mi">3600L</span><span class="o">,</span> <span class="n">roles</span><span class="o">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="n">jwt</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p><strong>All done, we can test now!</strong></p>

<h2 id="test">Test</h2>

<p>Through the above steps, a complete auth function project is completed. Someone maybe think that with only these few steps, where is its complete function and what can it support?
This built project is based on the RBAC permission model and supports Basic authentication, Digest authentication and JWT authentication. It can fine-grained control the userâ€™s access to the REST API provided by the Javalin. That is to control which users can access which API.</p>

<p>Letâ€™s test it. (we use postman and chrome to test.)</p>

<h3 id="test-authentication">Test Authentication</h3>

<h4 id="1-basic-auth-test">1. Basic Auth Test</h4>

<p>Use postman Basic auth, as shown below:</p>

<ul>
  <li>success - input username: admin, password: admin</li>
</ul>

<p><img src="/img/posts/javalinSureness/test1.PNG" alt="success" /></p>

<ul>
  <li>fail - input username: admin, password: 12345</li>
</ul>

<p><img src="/img/posts/javalinSureness/test2.PNG" alt="fail" /></p>

<h4 id="2-digest-auth-test">2. Digest Auth Test</h4>

<p>Note: If password has been encrypted,  Digest auth not support.(So the account admin not support Digest auth).
Use chrome to Digest auth, as shown below:</p>

<p><img src="/img/posts/javalinSureness/test3.PNG" alt="success" /></p>

<p><img src="/img/posts/javalinSureness/test4.PNG" alt="success" /></p>

<h4 id="3-jwt-auth-test">3. JWT Auth Test</h4>

<p>First, we should access <strong>[GET /auth/token]</strong> API to get a JWT to use, as shown below:</p>

<p><img src="/img/posts/javalinSureness/test5.PNG" alt="success" /></p>

<p>Then, use the JWT as Bearer Token to access REST API, as shown below:</p>

<p><img src="/img/posts/javalinSureness/test6.PNG" alt="success" /></p>

<h3 id="test-authorization">Test Authorization</h3>

<ul>
  <li>success - user <strong>tom</strong> has role <strong>role3</strong>, the API  <strong>[DELETE - /api/v2/host]</strong> support <strong>role3</strong> access, so <strong>tom</strong> can access API  <strong>[DELETE - /api/v2/host]</strong> success, as shown below:</li>
</ul>

<p><img src="/img/posts/javalinSureness/test7.PNG" alt="success" /></p>

<ul>
  <li>fail - user <strong>tom</strong> only has role <strong>role3</strong>, the API  <strong>[GET - /api/v1/source1]</strong> only support <strong>role2</strong> access, not support <strong>role3</strong>,  so <strong>tom</strong> can not access API  <strong>[GET - /api/v1/source1]</strong>, as shown below:</li>
</ul>

<p><img src="/img/posts/javalinSureness/test8.PNG" alt="fail" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>Javalin is a framework dedicated to simplicity and ease of use, and so is Sureness.
We hope you enjoy this tutorial. Of course, the tutorial only introduces a simple introduction. Our account data, role permission data can not only be written in <code class="language-plaintext highlighter-rouge">sureness.yml</code>, but also loaded and obtained from the database and annotations. We can also customize the authentication method, data source, etc.
Finally, thank you again for reading.</p>

<p><a href="https://github.com/usthe/sureness/tree/master/samples/javalin-sureness">DEMO SOURCE CODE ON GITHUB</a></p>

    </div>
    <h3>Thanks for reading</h3>
    If you find any errors, please <a href="https://github.com/javalin/javalin.github.io/blob/master/_posts/tutorials/community/2021-04-16-javalin-sureness-example.md">edit this page on GitHub</a>.
    <br>
    
</article>
<style>
    .social {
        margin: 30px 0;
        display: flex;
    }
    .social-btn {
        text-align: center;
        min-width: 240px;
        padding: 10px 16px 8px;
        font-size: 14px;
        font-family: 'Roboto Slab', sans-serif;
        font-weight: 600;
        color: #fff;
        background: #000;
        border-radius: 50px;
        box-shadow: 2px 2px red, -2px -2px cyan;
    }
    .social-btn + .social-btn {
        margin-left: 24px;
    }
    .social-btn:hover {
        background: #008ab4;
    }
    .social-btn img {
        width: 24px;
        display: inline;
        vertical-align: middle;
        margin-right: 12px;
    }
    @media (max-width: 480px) {
        .social {
            justify-content: space-between;
        }
        .social-btn {
            min-width: 0;
            width: calc(50% - 12px);
            text-align: left;
            display: flex;
            align-items: center;
        }
        .social-btn + .social-btn {
            margin-left: 0;
        }
    }
</style>
<div class="social">
    <a class="social-btn" href="https://twitter.com/intent/tweet?text=Using Sureness to protect the security of Javalin REST API&url=https://zugazagoitia.github.io/2021/04/16/javalin-sureness-example.html&via=javalin_io&related=javalin_io"
       rel="nofollow"
       title="Share on Twitter">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAM1BMVEUAAAD///////////////////////////////////////////////////////////////+3leKCAAAAEHRSTlMA8BDQwKCAMOBwYECwUCCQ27fl2AAAAW1JREFUWMPtltuOwyAMRLG5QxL8/1+7G6lKFApMaJ5W2/NIPCPAnlL15R+xRSM7ZPMnci5yYvxrNRt3VMRtpPdBLqR9MWkhPkpI80BPUpFy2dfiUbKK9B02kjbmrCkycNAdfeCqpuOQOnrye2teRS9LrxqEjn4tQSS/io7Fxg1Kn/MWjxX7dgw30NvGNkO9CQP1O8v7oGEDq07i9Uu+YxAvs1J91GmDBtdQLVKjYz6/YINNWujiVgsMet3CqAr7yICKn3XQF4N9gizJDAsIDMSBLkIyyDzkmjqmWb0GoYUUBVKLWFUF6yk9gccDYtU7bKabWBNv9yKoDunmTcSW2Im+uwNi1cBP5+DjUSAGrzgiVcLZSBmlHjnQBv7L4AOMYEdwiAGcFgK/A5BN9/WsMCs90nsjT/SrGd0fI3UJIIIdovtlAUnWftA5KwiKakg2Y7ljfPn9tzWkUw5GsHV059UEOVpDR2wXl1l9+RP8AHA4c7ljId3mAAAAAElFTkSuQmCC">Share on Twitter
    </a>
    <a class="social-btn" href="https://facebook.com/sharer.php?u=https://zugazagoitia.github.io/2021/04/16/javalin-sureness-example.html"
       rel="nofollow"
       title="Share on Facebook">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABABAMAAABYR2ztAAAAMFBMVEUAAAD///////////////////////////////////////////////////////////87TQQwAAAAD3RSTlMAwIDwEEDgMKBgINBwUJA4su2wAAAAy0lEQVRIx2MYJICr+T9WkOQAVTD/Pw5gDpHn/I8TXAAriMetwAqsQB63gh9gBf/xgAFT8E0QCPJxK/ixACTqj1PB5wCwKD9OBbsY8Cv4XEBAwU8GAgoECCmYABTB5QuEUI2S0n4cCn6DRBzxhORHkMh5Qgr0h7eCjw6I/BiPTcEnBgRgxKbgK5ICPkIKmGij4C+yIwn5gg2bgm9ICuIHa2SNKqCZgs9gBf2YClBTkDNuBSlgBeyYCtDKzGJcCtKhyY+lH7sCIweGwQEAY2jNUu1+zZgAAAAASUVORK5CYII=">Share on Facebook
    </a>
</div>


    </main>
    <footer>
        Javalin is a Java and Kotlin web framework, open sourced under the
        <a href="https://tldrlegal.com/license/apache-license-2.0-(apache-2.0)">Apache 2</a> license
        | <a href="/download">Download</a>
        | <a href="/about">About</a>
        | <a href="/news">News</a>
        | <a href="/about#contact">Contact</a>
        | <a href="/for-educators">For educators</a>
    </footer>
    <div id="star-begging">
    <style>
        #star-begging {
            transition: transform .25s;
            transform: scale(0);
            border-radius: 8px;
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 20px 40px 16px 20px;
            background: #fff;
            box-shadow: 0 1px 20px rgba(0, 0, 0, 0.15);
            z-index: 9999998;
        }
        #star-begging.in {
            transform: scale(1);
        }
        #star-begging.out {
            transform: translateX(400px);
        }
        #star-begging p {
            font-size: 16px;
            margin: 0 0 15px;
        }
        #star-begging .close {
            position: absolute;
            right: 20px;
            top: 20px;
            height: 40px;
            width: 40px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-family: arial, sans-serif;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 5px;
        }
    </style>
    <p>
        Like Javalin?
        <br>Star us ðŸ˜Š
    </p>
    <span class="close">Ã—</span>
    <iframe id="starFrame" class="githubStar" title="github-stars"
            src="https://ghbtns.com/github-btn.html?user=javalin&amp;repo=javalin&amp;type=star&amp;count=true&size=large"
            frameborder="0" scrolling="0" width="150px" height="30px">
    </iframe>
    <script>
        if (localStorage.getItem("dismissed") !== "true" && document.getElementById("notification-banner") === null) {
            setTimeout(function () {
                document.querySelector("#star-begging").classList.add("in");
            }, 15000);
            document.querySelector("#star-begging .close").addEventListener("click", function () {
                document.querySelector("#star-begging").classList.add("out");
                localStorage.setItem("dismissed", "true");
            });
        }
    </script>
</div>

    <script src="/js/scripts.js"></script>
</body>
</html>
